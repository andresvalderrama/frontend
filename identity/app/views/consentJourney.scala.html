@import conf.Static
@import views.support.RenderClasses
@import model.{ApplicationContext, IdentityPage}
@import com.gu.identity.model.EmailNewsletters
@import services.EmailPrefsData
@import form.IdFormHelpers.nonInputFields
@import views.support.`package`.Seq2zipWithRowInfo
@import views.support.fragment.Switch._
@import views.support.fragment.ConsentBlock._
@import views.support.fragment.ConsentChannel._
@import common.LinkTo
@import controllers.editprofile.ProfileForms
@import _root_.utils.ConsentsJourneyType._

@(
    user: com.gu.identity.model.User,
    forms: ProfileForms,
    journey: AnyConsentsJourney,
    verifiedReturnUrl: String,
    idRequest: services.IdentityRequest,
    idUrlBuilder: services.IdentityUrlBuilder,
    emailPrefsForm: Form[EmailPrefsData],
    emailSubscriptions: List[String],
    availableLists: EmailNewsletters,
    consentHint: Option[String] = None,
    skin: Option[String] = None)(implicit request: RequestHeader, messages: play.api.i18n.Messages, context: model.ApplicationContext)

@selectAllCheckbox(id: String) = {
    <label class="manage-account__switch manage-account__switch--no-box js-manage-account__check-allCheckbox u-h" data-link-name-template="mma switch : @{id} (all) : [action]">
        <div class="manage-account__switch-content">
            <input type="checkbox"/>
            <div class="manage-account__switch-checkbox"></div>
            <h3 class="manage-account__switch-title"></h3>
        </div>
    </label>
}

@onlySubscribedToV1Newsletters = @{
    EmailNewsletters.all.subscriptions.filter { newsletter =>
        emailSubscriptions.contains(newsletter.listIdV1.toString)
    }
}

@channelStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul>
            @helper.repeatWithIndex(forms.privacyForm("consents"), min=1) { (consentField, index) =>
                @if(isUsersChannel(consentField, user)) {
                    <li>
                        @fragments.consentSwitch(consentField)(messages)
                    </li>
                }
            }
            </ul>
        </div>
    </form>
}

@channelStep = @{
    ConsentStep(
        name = "channels",
        title = "How else can we get in touch with you?",
        help = List(
            ConsentStepHelpText("Besides email, are there any other ways you would like us to get in touch with you?")
        ),
        content = channelStepContent,
        show = channelsProvidedBy(user).nonEmpty
    )
}

@marketingStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul class="manage-account__switches-head">
                <li>
                    @selectAllCheckbox("marketing-consents")
                </li>
            </ul>
            <ul>
            @helper.repeatWithIndex(forms.privacyForm("consents"), min = 1) { (consentField, index) =>
                <li>
                    @if(!isChannel(consentField)) {
                        @if(index == 0) {
                            @fragments.consentSwitch(consentField, consentHint)(messages)
                        } else {
                            @fragments.consentSwitch(consentField)(messages)
                        }
                    }
                </li>
            }
            </ul>
        </div>
    </form>
}
@marketingConsentStep = @{
    ConsentStep(
        name = "marketing-consents",
        title = "Would you like to hear about any of these Guardian products?",
        help = List(ConsentStepHelpText("Set your preferences: Please let us know if you are interested in any of these products or services.")),
        content = marketingStepContent
    )
}

@emailRepermissionStepContent = {
    <form action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        @fragments.form.hidden(emailPrefsForm("htmlPreference"))
        <div class="manage-account__switches manage-account__switches--single-column">
            <ul class="manage-account__switches-head">
                <li>
                    @selectAllCheckbox("email-repermission")
                </li>
            </ul>
            <ul>
            @onlySubscribedToV1Newsletters.zipWithRowInfo.map { case (newsletter, row) =>
            <li>
                @fragments.newsletterSwitch(
                    emailPrefsForm,
                    emailSubscriptions,
                    newsletter = newsletter,
                    unchecked = true
                )(nonInputFields, messages, request)
            </li>
            }
            </ul>
        </div>
    </form>
}
@emailRepermissionStep() = @{
    ConsentStep(
        name = "email",
        title = "Please select the newsletters you wish to continue receiving.",
        help = List(
            ConsentStepHelpLegalText("The Guardian’s newsletters include content from our website, which may be funded by outside parties. Newsletters may also display information about Guardian News and Media's other products, services or events (such as Guardian Jobs or Masterclasses), chosen charities or online advertisements.")
        ),
        content = emailRepermissionStepContent,
        show = onlySubscribedToV1Newsletters.nonEmpty
    )
}

@emailSignupStepContent = {
    <form novalidate action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
        @views.html.helper.CSRF.formField
        @fragments.form.hidden(emailPrefsForm("htmlPreference"))

        <div class="manage-account__switches">
            @fragments.emailListCategories(emailPrefsForm,availableLists,emailSubscriptions)(request, messages)
        </div>
    </form>
}
@emailSignupStep() = @{
    ConsentStep(
        name = "email-signup",
        title = "Your newsletters",
        help = List(
            ConsentStepHelpText("Our regular newsletters help you get closer to our quality, independent journalism. Pick the issues and topics that interest you below."),
            ConsentStepHelpLegalText("The Guardian’s newsletters include content from our website, which may be funded by outside parties. Newsletters may also display information about Guardian News and Media's other products, services or events (such as Guardian Jobs or Masterclasses), chosen charities or online advertisements.")
        ),
        content = emailSignupStepContent,
        show = true
    )
}

@emailRepermissionOrSignupStep = @{
    if(emailRepermissionStep.show) {
        emailRepermissionStep()
    } else {
        emailSignupStep()
    }
}

<div class="identity-wrapper monocolumn-wrapper">
    <div class="js-errorHolder manage-account__errors"></div>
    @consentJourneyFragments.jsFallback(verifiedReturnUrl, idRequest, idUrlBuilder)
    <div class="identity-consent-journey @{skin.map(s => s"identity-consent-journey--$s" )} u-h" data-journey="@journey" data-component="identity-consent-journey-@journey">

        @renderBlocks(
            journey match {
                case NewsletterConsentsJourney => {
                    List(
                        if(emailRepermissionStep.show) {
                            emailRepermissionStep
                        } else {
                            ConsentStep(
                                name = "error",
                                title = "Sorry",
                                content = Html("<p class=\"form__error\">Something went wrong updating your newsletters.</p>")
                            )
                        }
                    )
                }
                case ThankYouConsentsJourney => {
                    List(
                        ConsentBanner(
                            "Thank you for signing up"
                        ),
                        emailRepermissionStep,
                        marketingConsentStep,
                        channelStep
                    )
                }
                case DefaultConsentsJourney => {
                    List(
                        emailRepermissionStep,
                        marketingConsentStep,
                        channelStep
                    )
                }
            }
        )

        <form class="identity-consent-journey__controls" method="POST" action="@idUrlBuilder.buildUrl("/complete-consents", idRequest)">
            <input type="hidden" name="returnUrl" value="@verifiedReturnUrl" />
            @views.html.helper.CSRF.formField
            <button
                type="submit"
                class="manage-account__button--icon manage-account__button @{skin.map(s => s"manage-account__button--$s" )}"
                data-link-name="consents : navigation : submit"
            >
                <div class="manage-account__button-flexwrap">
                    <span>Finish</span>
                    @fragments.inlineSvg("tick-button", "icon")
                </div>
            </button>
        </form>
    </div>

</div>
